{% extends "base.html" %}

{% block content %}
<div class="filters">
    <form method="get" action="{{ url_for('index') }}" id="filter-form">
        <div class="search-box">
            <input type="text" name="q" id="search-input" value="{{ search_query }}" placeholder="Search titles and notes..." autocomplete="off">
            <span id="search-loading" class="loading-indicator" style="display: none;">...</span>
        </div>

        <div class="filter-row">
            <select name="status" id="status-filter" onchange="doSearch()">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                    <option value="{{ status.id }}" {% if current_status == status.id|string %}selected{% endif %}>{{ status.display_name }}</option>
                {% endfor %}
            </select>

            <select name="tag" id="tag-filter" onchange="doSearch()">
                <option value="">All Tags</option>
                {% for tag in tags %}
                    <option value="{{ tag.name }}" {% if current_tag == tag.name %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}
            </select>

            <a href="{{ url_for('index') }}" class="btn btn-secondary" id="clear-btn" {% if not current_status and not current_tag and not search_query %}style="display: none;"{% endif %}>Clear</a>
        </div>
    </form>
</div>

{% if items %}
<div class="status-groups" id="status-groups">
    {% for group in grouped_items %}
        {% if group.entries %}
        <div class="status-group" data-status-id="{{ group.status.id if group.status else 'none' }}" draggable="true">
            <div class="status-group-header">
                <span class="drag-handle" title="Drag to reorder">&#9776;</span>
                <h3>
                    {% if group.status %}
                        <span class="status-badge status-{{ group.status.color }}">{{ group.status.display_name }}</span>
                    {% else %}
                        <span class="status-badge status-gray">No Status</span>
                    {% endif %}
                    <span class="item-count">({{ group.entries|length }})</span>
                </h3>
                <button type="button" class="collapse-toggle" title="Collapse/Expand">
                    <span class="collapse-icon">&#9660;</span>
                </button>
            </div>
            <div class="items-list collapsible">
                {% for item in group.entries %}
                <div class="item-card">
                    <div class="item-header">
                        <h3>
                            <a href="{{ url_for('view', id=item.id) }}">{{ item.title }}</a>
                        </h3>
                    </div>

                    {% if item.link %}
                    <p class="item-link"><a href="{{ item.link }}" target="_blank">{{ item.link[:50] }}{% if item.link|length > 50 %}...{% endif %}</a></p>
                    {% endif %}

                    <div class="item-progress">
                        <form method="post" action="{{ url_for('update_progress', id=item.id) }}" class="progress-form">
                            <label>Chapter:</label>
                            <input type="number" name="chapter_current" value="{{ item.chapter_current }}" min="0" class="chapter-input">
                            {% if item.chapter_total %}
                                <span>/ {{ item.chapter_total }}</span>
                            {% endif %}
                            <button type="submit" class="btn btn-small">Update</button>
                        </form>
                        {% if item.progress_percent is not none %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ item.progress_percent }}%"></div>
                        </div>
                        <span class="progress-text">{{ item.progress_percent }}%</span>
                        {% endif %}
                    </div>

                    {% if item.tags %}
                    <div class="tags">
                        {% for tag in item.tags %}
                            <a href="{{ url_for('index', tag=tag.name) }}" class="tag">{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="item-actions">
                        <a href="{{ url_for('edit', id=item.id) }}" class="btn btn-secondary">Edit</a>
                        <form method="post" action="{{ url_for('delete', id=item.id) }}" class="delete-form" onsubmit="return confirm('Delete this item?');">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% else %}
<div class="empty-state" id="empty-state">
    <p>No reading materials found.</p>
    <a href="{{ url_for('add') }}" class="btn btn-primary">Add Your First Item</a>
</div>
{% endif %}

<div class="status-groups" id="status-groups-dynamic" style="display: none;"></div>
<div class="empty-state" id="empty-state-dynamic" style="display: none;">
    <p>No reading materials found.</p>
    <a href="{{ url_for('add') }}" class="btn btn-primary">Add Your First Item</a>
</div>

<script>
let searchTimeout;
const searchInput = document.getElementById('search-input');
const statusFilter = document.getElementById('status-filter');
const tagFilter = document.getElementById('tag-filter');
const clearBtn = document.getElementById('clear-btn');
const loadingIndicator = document.getElementById('search-loading');

function debounce(func, wait) {
    return function(...args) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function renderGroupedItems(groups) {
    const staticGroups = document.getElementById('status-groups');
    const staticEmpty = document.getElementById('empty-state');
    const dynamicGroups = document.getElementById('status-groups-dynamic');
    const dynamicEmpty = document.getElementById('empty-state-dynamic');

    // Hide static content
    if (staticGroups) staticGroups.style.display = 'none';
    if (staticEmpty) staticEmpty.style.display = 'none';

    const totalItems = groups.reduce((sum, g) => sum + g.items.length, 0);

    if (totalItems === 0) {
        dynamicGroups.style.display = 'none';
        dynamicEmpty.style.display = 'block';
        return;
    }

    dynamicEmpty.style.display = 'none';
    dynamicGroups.style.display = 'block';
    dynamicGroups.innerHTML = groups.map(group => `
        <div class="status-group" data-status-id="${group.status_id}" draggable="true">
            <div class="status-group-header">
                <span class="drag-handle" title="Drag to reorder">&#9776;</span>
                <h3>
                    <span class="status-badge status-${group.status_color}">${escapeHtml(group.status_name)}</span>
                    <span class="item-count">(${group.items.length})</span>
                </h3>
                <button type="button" class="collapse-toggle" title="Collapse/Expand">
                    <span class="collapse-icon">&#9660;</span>
                </button>
            </div>
            <div class="items-list collapsible">
                ${group.items.map(item => `
                    <div class="item-card">
                        <div class="item-header">
                            <h3><a href="/view/${item.id}">${escapeHtml(item.title)}</a></h3>
                        </div>
                        ${item.link ? `<p class="item-link"><a href="${escapeHtml(item.link)}" target="_blank">${escapeHtml(item.link.substring(0, 50))}${item.link.length > 50 ? '...' : ''}</a></p>` : ''}
                        <div class="item-progress">
                            <form method="post" action="/update-progress/${item.id}" class="progress-form">
                                <label>Chapter:</label>
                                <input type="number" name="chapter_current" value="${item.chapter_current}" min="0" class="chapter-input">
                                ${item.chapter_total ? `<span>/ ${item.chapter_total}</span>` : ''}
                                <button type="submit" class="btn btn-small">Update</button>
                            </form>
                            ${item.progress_percent !== null ? `
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${item.progress_percent}%"></div>
                                </div>
                                <span class="progress-text">${item.progress_percent}%</span>
                            ` : ''}
                        </div>
                        ${item.tags.length > 0 ? `
                            <div class="tags">
                                ${item.tags.map(tag => `<a href="/?tag=${encodeURIComponent(tag)}" class="tag">${escapeHtml(tag)}</a>`).join('')}
                            </div>
                        ` : ''}
                        <div class="item-actions">
                            <a href="/edit/${item.id}" class="btn btn-secondary">Edit</a>
                            <form method="post" action="/delete/${item.id}" class="delete-form" onsubmit="return confirm('Delete this item?');">
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');

    // Re-initialize collapse and drag after dynamic render
    initCollapse();
    initDragAndDrop();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function doSearch() {
    const query = searchInput.value;
    const status = statusFilter.value;
    const tag = tagFilter.value;

    // Show/hide clear button
    clearBtn.style.display = (query || status || tag) ? 'inline-block' : 'none';

    // Update URL without reload
    const params = new URLSearchParams();
    if (query) params.set('q', query);
    if (status) params.set('status', status);
    if (tag) params.set('tag', tag);
    const newUrl = params.toString() ? `/?${params.toString()}` : '/';
    history.replaceState(null, '', newUrl);

    loadingIndicator.style.display = 'inline';

    fetch(`/api/search?${params.toString()}`)
        .then(response => response.json())
        .then(groups => {
            loadingIndicator.style.display = 'none';
            renderGroupedItems(groups);
        })
        .catch(err => {
            loadingIndicator.style.display = 'none';
            console.error('Search error:', err);
        });
}

searchInput.addEventListener('input', debounce(doSearch, 300));

// Collapse functionality
function initCollapse() {
    document.querySelectorAll('.collapse-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
            const group = this.closest('.status-group');
            const content = group.querySelector('.collapsible');
            const icon = this.querySelector('.collapse-icon');
            const statusId = group.dataset.statusId;

            group.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            if (group.classList.contains('collapsed')) {
                icon.innerHTML = '&#9654;'; // Right arrow
                saveCollapsedState(statusId, true);
            } else {
                icon.innerHTML = '&#9660;'; // Down arrow
                saveCollapsedState(statusId, false);
            }
        });
    });

    // Restore collapsed states from localStorage
    restoreCollapsedStates();
}

function saveCollapsedState(statusId, isCollapsed) {
    const states = JSON.parse(localStorage.getItem('collapsedGroups') || '{}');
    states[statusId] = isCollapsed;
    localStorage.setItem('collapsedGroups', JSON.stringify(states));
}

function restoreCollapsedStates() {
    const states = JSON.parse(localStorage.getItem('collapsedGroups') || '{}');
    document.querySelectorAll('.status-group').forEach(group => {
        const statusId = group.dataset.statusId;
        if (states[statusId]) {
            group.classList.add('collapsed');
            group.querySelector('.collapsible').classList.add('collapsed');
            group.querySelector('.collapse-icon').innerHTML = '&#9654;';
        }
    });
}

// Drag and drop functionality
let draggedElement = null;

function initDragAndDrop() {
    const container = document.querySelector('.status-groups:not([style*="display: none"])');
    if (!container) return;

    container.querySelectorAll('.status-group').forEach(group => {
        group.addEventListener('dragstart', handleDragStart);
        group.addEventListener('dragend', handleDragEnd);
        group.addEventListener('dragover', handleDragOver);
        group.addEventListener('drop', handleDrop);
        group.addEventListener('dragenter', handleDragEnter);
        group.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.status-group').forEach(group => {
        group.classList.remove('drag-over');
    });
    saveGroupOrder();
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    e.stopPropagation();
    e.preventDefault();

    if (draggedElement !== this) {
        const container = this.parentNode;
        const allGroups = [...container.querySelectorAll('.status-group')];
        const draggedIndex = allGroups.indexOf(draggedElement);
        const targetIndex = allGroups.indexOf(this);

        if (draggedIndex < targetIndex) {
            container.insertBefore(draggedElement, this.nextSibling);
        } else {
            container.insertBefore(draggedElement, this);
        }
    }

    this.classList.remove('drag-over');
    return false;
}

function saveGroupOrder() {
    const container = document.querySelector('.status-groups:not([style*="display: none"])');
    if (!container) return;

    const order = [...container.querySelectorAll('.status-group')].map(g => g.dataset.statusId);
    localStorage.setItem('groupOrder', JSON.stringify(order));
}

function restoreGroupOrder() {
    const order = JSON.parse(localStorage.getItem('groupOrder') || '[]');
    if (order.length === 0) return;

    const container = document.querySelector('.status-groups:not([style*="display: none"])');
    if (!container) return;

    const groups = [...container.querySelectorAll('.status-group')];
    const groupMap = {};
    groups.forEach(g => groupMap[g.dataset.statusId] = g);

    order.forEach(statusId => {
        if (groupMap[statusId]) {
            container.appendChild(groupMap[statusId]);
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initCollapse();
    initDragAndDrop();
    restoreGroupOrder();
});
</script>
{% endblock %}
